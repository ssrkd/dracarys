import React, { useState, useEffect } from 'react'
import { useNavigate, useSearchParams } from 'react-router-dom'
import { supabase } from '../supabaseClient'

export default function LoginNew({ onLogin }) {
  const navigate = useNavigate()
  const [searchParams, setSearchParams] = useSearchParams()
  const isRegisterMode = searchParams.get('mode') === 'register'

  // States
  const [currentStep, setCurrentStep] = useState(1) // 1: phone, 2: register
  const [phone, setPhone] = useState('')
  const [formData, setFormData] = useState({
    firstName: '',
    lastName: '',
    birthDate: '',
    gender: '',
    city: '',
    password: ''
  })
  const [isLoading, setIsLoading] = useState(false)
  const [errorMessage, setErrorMessage] = useState('')
  const [dateError, setDateError] = useState('') // Отдельная ошибка для даты

  useEffect(() => {
    window.scrollTo(0, 0)
    if (isRegisterMode) {
      setCurrentStep(1)
    }
  }, [isRegisterMode])

  // Phone formatting: +7 XXX-(XXX)-XX-XX
  const formatPhoneNumber = (value) => {
    // Извлекаем только цифры
    let digits = value.replace(/\D/g, '')
    
    // Если ничего не введено, возвращаем пустую строку
    if (digits.length === 0) return ''
    
    // Если первая цифра не 7, заменяем или добавляем 7
    if (digits.charAt(0) !== '7') {
      digits = '7' + digits
    }
    
    // Теперь берем цифры после 7 (максимум 10)
    const afterSeven = digits.slice(1, 11)
    
    // Форматируем в зависимости от количества цифр
    if (afterSeven.length === 0) return ''
    if (afterSeven.length <= 3) return afterSeven
    if (afterSeven.length <= 6) return afterSeven.slice(0, 3) + '-(' + afterSeven.slice(3)
    if (afterSeven.length <= 8) return afterSeven.slice(0, 3) + '-(' + afterSeven.slice(3, 6) + ')-' + afterSeven.slice(6)
    return afterSeven.slice(0, 3) + '-(' + afterSeven.slice(3, 6) + ')-' + afterSeven.slice(6, 8) + '-' + afterSeven.slice(8, 10)
  }

  // Get clean phone number (11 digits with country code 7) for database
  const getCleanPhone = (formattedPhone) => {
    const digits = formattedPhone.replace(/\D/g, '')
    // Всегда возвращаем 7 + 10 цифр
    return '7' + digits.slice(0, 10)
  }

  // Name formatting
  const formatName = (value) => {
    const letters = value.replace(/[^a-zA-Zа-яА-ЯёЁ]/g, '')
    if (letters.length === 0) return ''
    return letters.charAt(0).toUpperCase() + letters.slice(1).toLowerCase()
  }

  // Date formatting and validation
  const formatDate = (value) => {
    const digits = value.replace(/\D/g, '')
    if (digits.length <= 2) return digits
    if (digits.length <= 4) return digits.slice(0, 2) + '.' + digits.slice(2)
    return digits.slice(0, 2) + '.' + digits.slice(2, 4) + '.' + digits.slice(4, 8)
  }

  // Validate date in real time
  const validateDate = (dateStr) => {
    if (!dateStr || dateStr.replace(/\D/g, '').length !== 8) {
      return { valid: false, error: '' }
    }

    const match = dateStr.match(/^(\d{2})\.(\d{2})\.(\d{4})$/)
    if (!match) {
      return { valid: false, error: 'Неверный формат даты' }
    }

    const [, day, month, year] = match
    const dayNum = parseInt(day)
    const monthNum = parseInt(month)
    const yearNum = parseInt(year)

    if (dayNum < 1 || dayNum > 31) {
      return { valid: false, error: 'Неверный день (от 1 до 31)' }
    }

    if (monthNum < 1 || monthNum > 12) {
      return { valid: false, error: 'Неверный месяц (от 1 до 12)' }
    }

    if (yearNum < 1960) {
      return { valid: false, error: 'Минимум год рождения: 1960' }
    }

    const today = new Date()
    const inputDate = new Date(yearNum, monthNum - 1, dayNum)
    
    if (inputDate > today) {
      return { valid: false, error: 'Дата не может быть в будущем' }
    }

    // Check if date is valid (e.g., not 31.02.2000)
    if (inputDate.getDate() !== dayNum || inputDate.getMonth() !== monthNum - 1 || inputDate.getFullYear() !== yearNum) {
      return { valid: false, error: 'Неверная дата рождения' }
    }

    return { valid: true, error: '' }
  }

  const cities = [
    'Алматы', 'Астана', 'Шымкент', 'Актобе', 'Караганда', 'Тараз', 'Павлодар',
    'Усть-Каменогорск', 'Семей', 'Атырау', 'Костанай', 'Кызылорда', 'Уральск',
    'Петропавловск', 'Актау', 'Темиртау', 'Туркестан', 'Кокшетау', 'Талдыкорган',
    'Экибастуз', 'Рудный', 'Жанаозен', 'Балхаш', 'Сатпаев', 'Жезказган',
    'Кентау', 'Капшагай', 'Степногорск', 'Аксай', 'Атбасар'
  ]

  // Step 1: Phone verification
  const handlePhoneSubmit = async (e) => {
    e.preventDefault()
    setErrorMessage('')

    const cleanPhone = getCleanPhone(phone)
    const phoneDigits = cleanPhone.replace(/\D/g, '')
    
    // Проверяем что есть 11 цифр (7 + 10)
    if (phoneDigits.length !== 11) {
      setErrorMessage('Введите корректный номер телефона (10 цифр после +7)')
      return
    }

    setIsLoading(true)

    try {
      const { data: customer, error } = await supabase
        .from('customers')
        .select('*')
        .eq('phone', cleanPhone)
        .maybeSingle()

      if (error) throw error

      if (customer) {
        // Existing customer - сразу логиним (временно убрали код)
        onLogin(customer)
      } else {
        // New customer
        if (isRegisterMode) {
          setCurrentStep(2)
        } else {
          setErrorMessage('Аккаунт не найден. Пожалуйста, зарегистрируйтесь.')
        }
      }
    } catch (err) {
      setErrorMessage('Ошибка: ' + (err.message || 'Попробуйте позже'))
    } finally {
      setIsLoading(false)
    }
  }

  // Step 2: Registration
  const handleRegistration = async (e) => {
    e.preventDefault()
    setErrorMessage('')

    // Validation
    if (!formData.firstName.trim() || formData.firstName.trim().length < 2) {
      setErrorMessage('Имя должно содержать минимум 2 буквы')
      return
    }

    if (!formData.lastName.trim() || formData.lastName.trim().length < 2) {
      setErrorMessage('Фамилия должна содержать минимум 2 буквы')
      return
    }

    // Validate date
    const dateValidation = validateDate(formData.birthDate)
    if (!dateValidation.valid) {
      setErrorMessage(dateValidation.error || 'Неверная дата рождения')
      return
    }

    if (!formData.gender) {
      setErrorMessage('Выберите пол')
      return
    }

    if (!formData.city) {
      setErrorMessage('Выберите город')
      return
    }

    if (!formData.password || formData.password.length < 6) {
      setErrorMessage('Пароль должен содержать минимум 6 символов')
      return
    }

    setIsLoading(true)

    try {
      const fullname = `${formData.firstName.trim()} ${formData.lastName.trim()}`
      const cleanPhone = getCleanPhone(phone)
      const { data: newCustomer, error } = await supabase
        .from('customers')
        .insert([{
          phone: cleanPhone,
          fullname,
          first_name: formData.firstName.trim(),
          last_name: formData.lastName.trim(),
          birth_date: formData.birthDate,
          gender: formData.gender,
          city: formData.city,
          password: formData.password
        }])
        .select()
        .single()

      if (error) throw error
      onLogin(newCustomer)
    } catch (err) {
      setErrorMessage('Ошибка регистрации: ' + (err.message || 'Попробуйте позже'))
    } finally {
      setIsLoading(false)
    }
  }

  // Step 3: Code verification (temporarily disabled)
  const handleCodeVerification = async (e) => {
    e.preventDefault()
    // Temporarily disabled - login directly after phone check
  }

  const updateFormData = (field, value) => {
    setFormData(prev => ({ ...prev, [field]: value }))
  }

  return (
    <div style={{
      minHeight: '100vh',
      background: '#f5f5f7',
      position: 'relative',
      display: 'flex',
      flexDirection: 'column'
    }}>
      {/* Header */}
      <header style={{
        position: 'relative',
        zIndex: 10,
        padding: '20px 24px',
        background: '#fff',
        borderBottom: '1px solid #e5e5e5'
      }}>
        <div
          onClick={() => navigate('/')}
          style={{
            display: 'flex',
            alignItems: 'center',
            gap: '10px',
            cursor: 'pointer',
            width: 'fit-content'
          }}
        >
          <div style={{
            width: '36px',
            height: '36px',
            background: '#000',
            borderRadius: '10px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '18px',
            fontWeight: '700',
            color: '#fff'
          }}>
            Q
          </div>
          <div style={{
            fontSize: '17px',
            fontWeight: '600',
            color: '#000',
            letterSpacing: '-0.3px'
          }}>
            qaraa.kz
          </div>
        </div>
      </header>

      {/* Main Content */}
      <div style={{
        flex: 1,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '32px 16px'
      }}>
        <div style={{
          width: '100%',
          maxWidth: '400px',
          background: '#fff',
          borderRadius: '20px',
          padding: '40px 32px',
          boxShadow: '0 2px 16px rgba(0, 0, 0, 0.08)'
        }}>
          {/* Title Section */}
          <div style={{ textAlign: 'center', marginBottom: '32px' }}>
            <h1 style={{
              fontSize: '28px',
              fontWeight: '700',
              color: '#000',
              letterSpacing: '-0.5px',
              marginBottom: '8px'
            }}>
              {currentStep === 1 && (isRegisterMode ? 'Регистрация' : 'Вход')}
              {currentStep === 2 && 'Завершение регистрации'}
            </h1>
            <p style={{
              fontSize: '15px',
              color: '#86868b',
              fontWeight: '400'
            }}>
              {currentStep === 1 && (isRegisterMode
                ? 'Введите ваш номер телефона'
                : 'Войдите с помощью номера телефона')}
              {currentStep === 2 && 'Заполните информацию о себе'}
            </p>
          </div>

          {/* Step 1: Phone */}
          {currentStep === 1 && (
            <form onSubmit={handlePhoneSubmit}>
              <div style={{ marginBottom: '24px' }}>
                <label style={{
                  display: 'block',
                  fontSize: '13px',
                  fontWeight: '600',
                  color: '#333',
                  marginBottom: '10px',
                  letterSpacing: '0.2px'
                }}>
                  Номер телефона
                </label>
                <div style={{ position: 'relative' }}>
                  <div style={{
                    position: 'absolute',
                    left: '18px',
                    top: '50%',
                    transform: 'translateY(-50%)',
                    fontSize: '16px',
                    color: '#666',
                    fontWeight: '600',
                    zIndex: 1
                  }}>
                    +7
                  </div>
                  <input
                    type="tel"
                    value={phone}
                    onChange={(e) => setPhone(formatPhoneNumber(e.target.value))}
                    placeholder="777-(830)-75-88"
                    style={{
                      width: '100%',
                      padding: '17px 18px 17px 52px',
                      fontSize: '17px',
                      border: '2px solid #e5e5e5',
                      borderRadius: '16px',
                      transition: 'all 0.25s',
                      fontFamily: 'system-ui, -apple-system, sans-serif',
                      color: '#1a1a1a',
                      background: '#f8f8f8',
                      fontWeight: '500'
                    }}
                    onFocus={(e) => {
                      e.target.style.borderColor = '#667eea'
                      e.target.style.background = '#fff'
                      e.target.style.boxShadow = '0 0 0 5px rgba(102, 126, 234, 0.12)'
                    }}
                    onBlur={(e) => {
                      e.target.style.borderColor = '#e5e5e5'
                      e.target.style.background = '#f8f8f8'
                      e.target.style.boxShadow = 'none'
                    }}
                    disabled={isLoading}
                  />
                </div>
              </div>

              {errorMessage && (
                <div style={{
                  padding: '14px 18px',
                  background: 'linear-gradient(135deg, #fee 0%, #fcc 100%)',
                  color: '#c33',
                  borderRadius: '14px',
                  fontSize: '14px',
                  marginBottom: '24px',
                  border: '1px solid #faa',
                  fontWeight: '500'
                }}>
                  {errorMessage}
                </div>
              )}

              <button
                type="submit"
                disabled={isLoading || getCleanPhone(phone).replace(/\D/g, '').length !== 11}
                style={{
                  width: '100%',
                  padding: '18px',
                  background: isLoading || getCleanPhone(phone).replace(/\D/g, '').length !== 11
                    ? '#e8e8e8'
                    : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                  color: isLoading || getCleanPhone(phone).replace(/\D/g, '').length !== 11 ? '#aaa' : '#fff',
                  fontSize: '17px',
                  fontWeight: '600',
                  borderRadius: '16px',
                    cursor: isLoading || getCleanPhone(phone).replace(/\D/g, '').length !== 11 ? 'not-allowed' : 'pointer',
                  transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                  border: 'none',
                    boxShadow: isLoading || getCleanPhone(phone).replace(/\D/g, '').length !== 11
                      ? 'none'
                      : '0 10px 28px rgba(102, 126, 234, 0.35)'
                }}
                onMouseEnter={(e) => {
                  if (!isLoading && getCleanPhone(phone).replace(/\D/g, '').length === 11) {
                    e.target.style.transform = 'translateY(-2px)'
                    e.target.style.boxShadow = '0 14px 36px rgba(102, 126, 234, 0.45)'
                  }
                }}
                onMouseLeave={(e) => {
                  if (!isLoading && getCleanPhone(phone).replace(/\D/g, '').length === 11) {
                    e.target.style.transform = 'translateY(0)'
                    e.target.style.boxShadow = '0 10px 28px rgba(102, 126, 234, 0.35)'
                  }
                }}
              >
                {isLoading ? 'Проверка...' : 'Продолжить'}
              </button>
            </form>
          )}

          {/* Step 2: Registration */}
          {currentStep === 2 && (
            <form onSubmit={handleRegistration}>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '14px', marginBottom: '18px' }}>
                <div>
                  <label style={{
                    display: 'block',
                    fontSize: '13px',
                    fontWeight: '600',
                    color: '#333',
                    marginBottom: '10px',
                    letterSpacing: '0.2px'
                  }}>
                    Имя <span style={{ color: '#e53e3e' }}>*</span>
                  </label>
                  <input
                    type="text"
                    value={formData.firstName}
                    onChange={(e) => updateFormData('firstName', formatName(e.target.value))}
                    placeholder="Имя"
                    style={{
                      width: '100%',
                      padding: '17px 18px',
                      fontSize: '16px',
                      border: '2px solid #e5e5e5',
                      borderRadius: '16px',
                      transition: 'all 0.25s',
                      fontFamily: 'system-ui, -apple-system, sans-serif',
                      color: '#1a1a1a',
                      background: '#f8f8f8',
                      fontWeight: '500'
                    }}
                    onFocus={(e) => {
                      e.target.style.borderColor = '#667eea'
                      e.target.style.background = '#fff'
                      e.target.style.boxShadow = '0 0 0 5px rgba(102, 126, 234, 0.12)'
                    }}
                    onBlur={(e) => {
                      e.target.style.borderColor = '#e5e5e5'
                      e.target.style.background = '#f8f8f8'
                      e.target.style.boxShadow = 'none'
                    }}
                    disabled={isLoading}
                    autoFocus
                  />
                </div>
                <div>
                  <label style={{
                    display: 'block',
                    fontSize: '13px',
                    fontWeight: '600',
                    color: '#333',
                    marginBottom: '10px',
                    letterSpacing: '0.2px'
                  }}>
                    Фамилия <span style={{ color: '#e53e3e' }}>*</span>
                  </label>
                  <input
                    type="text"
                    value={formData.lastName}
                    onChange={(e) => updateFormData('lastName', formatName(e.target.value))}
                    placeholder="Фамилия"
                    style={{
                      width: '100%',
                      padding: '17px 18px',
                      fontSize: '16px',
                      border: '2px solid #e5e5e5',
                      borderRadius: '16px',
                      transition: 'all 0.25s',
                      fontFamily: 'system-ui, -apple-system, sans-serif',
                      color: '#1a1a1a',
                      background: '#f8f8f8',
                      fontWeight: '500'
                    }}
                    onFocus={(e) => {
                      e.target.style.borderColor = '#667eea'
                      e.target.style.background = '#fff'
                      e.target.style.boxShadow = '0 0 0 5px rgba(102, 126, 234, 0.12)'
                    }}
                    onBlur={(e) => {
                      e.target.style.borderColor = '#e5e5e5'
                      e.target.style.background = '#f8f8f8'
                      e.target.style.boxShadow = 'none'
                    }}
                    disabled={isLoading}
                  />
                </div>
              </div>

              <div style={{ marginBottom: '18px' }}>
                <label style={{
                  display: 'block',
                  fontSize: '13px',
                  fontWeight: '600',
                  color: '#333',
                  marginBottom: '10px',
                  letterSpacing: '0.2px'
                }}>
                  Дата рождения <span style={{ color: '#e53e3e' }}>*</span>
                </label>
                {dateError && (
                  <div style={{
                    padding: '10px 12px',
                    background: '#fff1f0',
                    color: '#cf1322',
                    borderRadius: '8px',
                    fontSize: '13px',
                    marginBottom: '10px',
                    border: '1px solid #ffccc7'
                  }}>
                    {dateError}
                  </div>
                )}
                <input
                  type="text"
                  value={formData.birthDate}
                  onChange={(e) => {
                    const formatted = formatDate(e.target.value)
                    updateFormData('birthDate', formatted)
                    // Real-time validation для даты
                    if (formatted.replace(/\D/g, '').length === 8) {
                      const validation = validateDate(formatted)
                      if (!validation.valid) {
                        setDateError(validation.error)
                      } else {
                        setDateError('')
                      }
                    } else if (formatted.replace(/\D/g, '').length > 0) {
                      setDateError('')
                    }
                  }}
                  placeholder="01.01.2001"
                  style={{
                    width: '100%',
                    padding: '17px 18px',
                    fontSize: '16px',
                    border: '2px solid #e5e5e5',
                    borderRadius: '16px',
                    transition: 'all 0.25s',
                    fontFamily: 'system-ui, -apple-system, sans-serif',
                    color: '#1a1a1a',
                    background: '#f8f8f8',
                    fontWeight: '500'
                  }}
                  onFocus={(e) => {
                    e.target.style.borderColor = '#667eea'
                    e.target.style.background = '#fff'
                    e.target.style.boxShadow = '0 0 0 5px rgba(102, 126, 234, 0.12)'
                  }}
                  onBlur={(e) => {
                    e.target.style.borderColor = '#e5e5e5'
                    e.target.style.background = '#f8f8f8'
                    e.target.style.boxShadow = 'none'
                  }}
                  disabled={isLoading}
                  maxLength={10}
                />
              </div>

              <div style={{ marginBottom: '18px' }}>
                <label style={{
                  display: 'block',
                  fontSize: '13px',
                  fontWeight: '600',
                  color: '#333',
                  marginBottom: '10px',
                  letterSpacing: '0.2px'
                }}>
                  Пол <span style={{ color: '#e53e3e' }}>*</span>
                </label>
                <div style={{ display: 'flex', gap: '12px' }}>
                  <button
                    type="button"
                    onClick={() => updateFormData('gender', 'male')}
                    disabled={isLoading}
                    style={{
                      flex: 1,
                      padding: '17px',
                      background: formData.gender === 'male'
                        ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                        : '#f5f5f5',
                      color: formData.gender === 'male' ? '#fff' : '#666',
                      fontSize: '16px',
                      fontWeight: '600',
                      borderRadius: '16px',
                      cursor: isLoading ? 'not-allowed' : 'pointer',
                      transition: 'all 0.25s',
                      border: formData.gender === 'male' ? 'none' : '2px solid #e5e5e5'
                    }}
                  >
                    Мужской
                  </button>
                  <button
                    type="button"
                    onClick={() => updateFormData('gender', 'female')}
                    disabled={isLoading}
                    style={{
                      flex: 1,
                      padding: '17px',
                      background: formData.gender === 'female'
                        ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                        : '#f5f5f5',
                      color: formData.gender === 'female' ? '#fff' : '#666',
                      fontSize: '16px',
                      fontWeight: '600',
                      borderRadius: '16px',
                      cursor: isLoading ? 'not-allowed' : 'pointer',
                      transition: 'all 0.25s',
                      border: formData.gender === 'female' ? 'none' : '2px solid #e5e5e5'
                    }}
                  >
                    Женский
                  </button>
                </div>
              </div>

              <div style={{ marginBottom: '18px' }}>
                <label style={{
                  display: 'block',
                  fontSize: '13px',
                  fontWeight: '600',
                  color: '#333',
                  marginBottom: '10px',
                  letterSpacing: '0.2px'
                }}>
                  Город <span style={{ color: '#e53e3e' }}>*</span>
                </label>
                <select
                  value={formData.city}
                  onChange={(e) => updateFormData('city', e.target.value)}
                  style={{
                    width: '100%',
                    padding: '17px 18px',
                    fontSize: '16px',
                    border: '2px solid #e5e5e5',
                    borderRadius: '16px',
                    transition: 'all 0.25s',
                    fontFamily: 'system-ui, -apple-system, sans-serif',
                    color: formData.city ? '#1a1a1a' : '#999',
                    background: '#f8f8f8',
                    cursor: 'pointer',
                    fontWeight: '500',
                    appearance: 'none',
                    backgroundImage: `url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%23666' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E")`,
                    backgroundRepeat: 'no-repeat',
                    backgroundPosition: 'right 18px center',
                    paddingRight: '48px'
                  }}
                  onFocus={(e) => {
                    e.target.style.borderColor = '#667eea'
                    e.target.style.background = '#fff'
                    e.target.style.boxShadow = '0 0 0 5px rgba(102, 126, 234, 0.12)'
                  }}
                  onBlur={(e) => {
                    e.target.style.borderColor = '#e5e5e5'
                    e.target.style.background = '#f8f8f8'
                    e.target.style.boxShadow = 'none'
                  }}
                  disabled={isLoading}
                >
                  <option value="" disabled>Выберите город</option>
                  {cities.map((cityName) => (
                    <option key={cityName} value={cityName}>
                      {cityName}
                    </option>
                  ))}
                </select>
              </div>

              <div style={{ marginBottom: '26px' }}>
                <label style={{
                  display: 'block',
                  fontSize: '13px',
                  fontWeight: '600',
                  color: '#333',
                  marginBottom: '10px',
                  letterSpacing: '0.2px'
                }}>
                  Пароль <span style={{ color: '#e53e3e' }}>*</span>
                </label>
                <input
                  type="password"
                  value={formData.password}
                  onChange={(e) => updateFormData('password', e.target.value)}
                  placeholder="Минимум 6 символов"
                  style={{
                    width: '100%',
                    padding: '17px 18px',
                    fontSize: '16px',
                    border: '2px solid #e5e5e5',
                    borderRadius: '16px',
                    transition: 'all 0.25s',
                    fontFamily: 'system-ui, -apple-system, sans-serif',
                    color: '#1a1a1a',
                    background: '#f8f8f8',
                    fontWeight: '500'
                  }}
                  onFocus={(e) => {
                    e.target.style.borderColor = '#667eea'
                    e.target.style.background = '#fff'
                    e.target.style.boxShadow = '0 0 0 5px rgba(102, 126, 234, 0.12)'
                  }}
                  onBlur={(e) => {
                    e.target.style.borderColor = '#e5e5e5'
                    e.target.style.background = '#f8f8f8'
                    e.target.style.boxShadow = 'none'
                  }}
                  disabled={isLoading}
                />
              </div>

              {errorMessage && (
                <div style={{
                  padding: '14px 18px',
                  background: 'linear-gradient(135deg, #fee 0%, #fcc 100%)',
                  color: '#c33',
                  borderRadius: '14px',
                  fontSize: '14px',
                  marginBottom: '24px',
                  border: '1px solid #faa',
                  fontWeight: '500'
                }}>
                  {errorMessage}
                </div>
              )}

              <div style={{ display: 'flex', gap: '12px' }}>
                <button
                  type="button"
                  onClick={() => {
                    setCurrentStep(1)
                    setFormData({
                      firstName: '',
                      lastName: '',
                      birthDate: '',
                      gender: '',
                      city: '',
                      password: ''
                    })
                    setErrorMessage('')
                  }}
                  disabled={isLoading}
                  style={{
                    flex: 1,
                    padding: '17px',
                    background: '#f5f5f5',
                    color: '#333',
                    fontSize: '16px',
                    fontWeight: '600',
                    borderRadius: '16px',
                    cursor: isLoading ? 'not-allowed' : 'pointer',
                    transition: 'all 0.25s',
                    border: '2px solid #e5e5e5'
                  }}
                >
                  Назад
                </button>
                <button
                  type="submit"
                  disabled={isLoading || !formData.firstName.trim() || !formData.lastName.trim() || 
                           !formData.birthDate || !formData.gender || !formData.city || !formData.password}
                  style={{
                    flex: 2,
                    padding: '17px',
                    background: (isLoading || !formData.firstName.trim() || !formData.lastName.trim() || 
                                !formData.birthDate || !formData.gender || !formData.city || !formData.password)
                      ? '#e8e8e8'
                      : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    color: (isLoading || !formData.firstName.trim() || !formData.lastName.trim() || 
                           !formData.birthDate || !formData.gender || !formData.city || !formData.password) ? '#aaa' : '#fff',
                    fontSize: '16px',
                    fontWeight: '600',
                    borderRadius: '16px',
                    cursor: (isLoading || !formData.firstName.trim() || !formData.lastName.trim() || 
                            !formData.birthDate || !formData.gender || !formData.city || !formData.password) ? 'not-allowed' : 'pointer',
                    transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                    border: 'none',
                    boxShadow: (isLoading || !formData.firstName.trim() || !formData.lastName.trim() || 
                               !formData.birthDate || !formData.gender || !formData.city || !formData.password)
                      ? 'none'
                      : '0 10px 28px rgba(102, 126, 234, 0.35)'
                  }}
                  onMouseEnter={(e) => {
                    if (!isLoading && formData.firstName.trim() && formData.lastName.trim() && 
                        formData.birthDate && formData.gender && formData.city && formData.password) {
                      e.target.style.transform = 'translateY(-2px)'
                      e.target.style.boxShadow = '0 14px 36px rgba(102, 126, 234, 0.45)'
                    }
                  }}
                  onMouseLeave={(e) => {
                    if (!isLoading && formData.firstName.trim() && formData.lastName.trim() && 
                        formData.birthDate && formData.gender && formData.city && formData.password) {
                      e.target.style.transform = 'translateY(0)'
                      e.target.style.boxShadow = '0 10px 28px rgba(102, 126, 234, 0.35)'
                    }
                  }}
                >
                  {isLoading ? 'Регистрация...' : 'Зарегистрироваться'}
                </button>
              </div>
            </form>
          )}


          {/* Footer */}
          <div style={{
            textAlign: 'center',
            marginTop: '32px',
            color: '#999',
            fontSize: '12px',
            lineHeight: '1.6'
          }}>
            Продолжая, вы соглашаетесь с{' '}
            <span
              onClick={() => navigate('/terms')}
              style={{
                color: '#667eea',
                cursor: 'pointer',
                textDecoration: 'underline',
                fontWeight: '500'
              }}
            >
              условиями
            </span>
            {' '}и{' '}
            <span
              onClick={() => navigate('/privacy')}
              style={{
                color: '#667eea',
                cursor: 'pointer',
                textDecoration: 'underline',
                fontWeight: '500'
              }}
            >
              политикой конфиденциальности
            </span>
          </div>
        </div>
      </div>

      <style>{`
        @keyframes pulse {
          0%, 100% { transform: scale(1) translate(0, 0); opacity: 0.8; }
          50% { transform: scale(1.1) translate(20px, -20px); opacity: 1; }
        }
        @media (max-width: 768px) {
          header { padding: 20px 24px !important; }
          div[style*="maxWidth: '480px'"] {
            padding: 40px 28px !important;
            border-radius: 24px !important;
          }
          h1 { font-size: 30px !important; }
          form > div[style*="grid"] {
            grid-template-columns: 1fr !important;
          }
        }
      `}</style>
    </div>
  )
}

